---
layout: post
title: CRA To Vite Migration
date: 2024-11-16
published: 2024-11-16
category: ê°œë°œ
tags: ['bundler']
comments: true
thumbnail: './assets/16/thumbnail.png'
github: 'https://github.com/seungahhong/seungahhong.github.io'
---

# Viteë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì´ìœ 

### ê¸°ì¡´ ëª¨ë“ˆ ë²ˆë“¤ëŸ¬ ë¬¸ì œì 

- ë¸Œë¼ìš°ì €ì—ì„œ Native ESM ë°©ì‹ì„ ì§€ì›í•˜ê¸° ì „ê¹Œì§€ëŠ” Javascript ëª¨ë“ˆí™”ë¥¼ ë¸Œë¼ìš°ì € ë ˆë²¨ì—ì„œ ì§„í–‰í•  ìˆ˜ ì—†ì—ˆê³ , í•´ë‹¹ ì†ŒìŠ¤ ëª¨ë“ˆì„ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›í•˜ê¸° ìœ„í•´ì„œ require/IIFE/import,exporë¥¼ í†µí•œ ëª¨ë“ˆí™” ë¬¸ë²•ì„ ì´ìš©í•˜ì—¬ì„œ ì—¬ëŸ¬ê°œì˜ íŒŒì¼ë¡œ í•©ì³ì£¼ê±°ë‚˜ ì˜ë¯¸ ìˆëŠ” ë‹¨ìœ„ë¡œ ë¬¶ì–´ì£¼ëŠ” ê¸°ëŠ¥ì„ ë²ˆë“¤ë§ì´ë¼ê³  í•˜ë©°, í˜„ì¬ëŠ” [**Webpack**](https://webpack.js.org/),Â [**Rollup**](https://rollupjs.org/)Â ê·¸ë¦¬ê³ Â [**Parcel**](https://parceljs.org/)ì„ ë„êµ¬ë“¤ì´ ì§€ì›í•˜ê³  ìˆìŠµë‹ˆë‹¤.
- í•˜ì§€ë§Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì ì  ë” ë°œì „í•¨ì— ë”°ë¼ì„œ JS ë„êµ¬ë“¤ì˜ ì„±ëŠ¥ ë³‘ëª© í˜„ìƒì´ ë°œìƒ, HMR ì‚¬ìš©í•˜ë”ë¼ë„ ë³€ê²½ëœ íŒŒì¼ ì ìš© ì‹œ ìˆ˜ì´ˆê°€ ê±¸ë ¤ì„œ ê°œë°œì ìƒì‚°ì„±ì„ ë–¨ì–´ëœ¨ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.
- ESM(ECMAScript Modules)

  - ESMì€ ëª¨ë“ˆí™” ë¬¸ë²•ì¸ import, exportë¥¼ ë³„ë„ì˜ ë„êµ¬ ì—†ì´ ë¸Œë¼ìš°ì € ìì²´ì—ì„œ ì†Œí™”í•´ ë‚¼ ìˆ˜ ìˆëŠ” ëª¨ë“ˆ ë°©ì‹ì„ ì˜ë¯¸í•œë‹¤. ë§Œì•½ ì•„ë˜ì™€ ê°™ì€ ì½”ë“œë¥¼ ì›¹íŒ©ê³¼ ê°™ì€ ë²ˆë“¤ëŸ¬ ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰í•˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.

  ```tsx
  // app.js
  import { sum } from 'test.js'
  console.log(sum(1,2));

  <script src="app.js></script>
  ```

  ![Untitled](./assets/06/Untitled.png)
  ì˜ˆì „ì—ëŠ” ë¸Œë¼ìš°ì €ê°€ importì™€ exportë¥¼ í•´ì„í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ ì—†ì—ˆì§€ë§Œ ì´ì œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì†ì„±ì„ ì¶”ê°€í•˜ë©´ ë¸Œë¼ìš°ì €ì—ì„œ importì™€ exportë¥¼ ì†Œí™”í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

  ```tsx
  <script type="module" src="app.mjs></script>
  ```

### Vite íŠ¹ì§•

- ì½œë“œ ìŠ¤íƒ€íŠ¸ ë°©ì‹ì˜ ê°œë°œ ì„œë²„ êµ¬ë™ì— ëŒ€í•œ ì„±ëŠ¥ ê°œì„ 
  ![Untitled](./assets/06/Untitled1.png)

  - Dependencies: node_modulesdì™€ ê°™ì´ ë‚´ìš©ì´ ë°”ë€Œì§€ ì•ŠëŠ” ì†ŒìŠ¤ì½”ë“œì— ëŒ€í•´ì„œ esbuild ì´ìš©í•œ ì‚¬ì „ ë²ˆë“¤ë§ ê¸°ëŠ¥ ì œê³µ

    - esbuildëŠ” webpack, parcelê³¼ ê°™ì€ ê¸°ì¡´ì˜ ë²ˆë“¤ëŸ¬ ëŒ€ë¹„ 10-100ë°° ë¹ ë¥¸ ì†ë„ë¥¼ ì œê³µ
    - esbuild ë¡œ node_modules ì˜ ëª¨ë“  íŒ¨í‚¤ì§€ë¥¼ ì‚¬ì „ ë²ˆë“¤ë§í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ serving í•˜ê³  ìºì‹œ

      ```tsx
      // Dependencies package import í•  ê²½ìš°
      import dayjs from 'dayjs';

      // vite esm ì§€ì›ì„ ìœ„í•œ ë³€í™˜/ìºì‹±
      /node_modules/.vite/deps/dayjs.js?v=b09621d8
      ```

  - Source code: Native ESM ë°©ì‹ì„ ì ìš©í•´ì„œ ë¸Œë¼ìš°ì €ê°€ ëª¨ë“ˆì„ ì§ì ‘ ê°€ì ¸ì˜¤ê³  ë³€í™˜ ë° ì œê³µí•˜ë„ë¡ ì²˜ë¦¬
    ![Untitled](./assets/06/Untitled2.png)

- HMR ì„±ëŠ¥ ê°œì„ 
  ê¸°ì¡´ ë²ˆë“¤ëŸ¬ ê¸°ë°˜ì—ì„œëŠ” ì†ŒìŠ¤ ì½”ë“œ ë³€ê²½ ì‹œ ë‹¤ì‹œ ë²ˆë“¤ë§ ê³¼ì •ì„ ë‹¤ì‹œ ìˆ˜í–‰í•˜ë‹¤ë³´ë‹ˆ ì„±ëŠ¥ì´ ëŠë ¤ì§€ëŠ” ì´ìŠˆë¥¼ Native ESM ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë³€ê²½ëœ ëª¨ë“ˆë§Œ êµì²´í•´ì„œ ì„±ëŠ¥ ê°œì„ 
  HTTP í—¤ë”ë¥¼ í™œìš©í•˜ì—¬ í˜ì´ì§€ ë¡œë“œ ì†ë„ ê°œì„ (ìš”ì²­ íšŸìˆ˜ ìµœì†Œí™”)
  - 304 Not Modified: í´ë¼ì´ì–¸íŠ¸ ìºì‹œ ì‚¬ìš©
  - Cache-Control: max-age=31536000, immutalble ì´ìš©í•œ ìºì‹œ ì‚¬ìš©
- í”„ë¡œë•ì…˜ í™˜ê²½ Rollup ì‚¬ìš©
  - ê°€ì¥ ë¹ ë¥¸ ì„±ëŠ¥ì„ ìë‘í•˜ëŠ” esbuildì´ì§€ë§Œ ì•„ì‰¬ìš´ ìƒíƒœê³„ì™€ ë¸Œë¼ìš°ì €ìš© ë²ˆë“¤ë§ì—ì„œëŠ” ì•ˆì •ì„±ì´ ë–¨ì–´ì§„ë‹¤ëŠ” í‰ê°€ê°€ ìˆì–´ì„œ viteì—ì„œëŠ” í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ Rollup ë²ˆë“¤ëŸ¬ë¥¼ ì‚¬ìš©(íŠ¸ë¦¬ ì…°ì´í‚¹, ì§€ì—°ë¡œë”©, íŒŒì¼ ë¶„í™œ ë“± ì„±ëŠ¥ ì´ì  ì œê³µ)
  - Rollupì€ v4ì—ì„œ íŒŒì„œë¥¼ SWC ì „í™˜ â†’ Rust í¬íŒ…ì¸ Rolldown ë§Œë“œëŠ” ì‘ì—…ì„ ì§„í–‰ ì¤‘ì´ë©° ê°œë°œì´ ì™„ë£Œëœë‹¤ë©´ esbuildë¥¼ ëª¨ë‘ ëŒ€ì²´ ê°€ëŠ¥(ê°œë°œ/ë¹Œë“œ ì‚¬ì´ì— ë¶ˆì´ì¹˜ ì œê±° ëª©í‘œ)
  - [https://www.youtube.com/watch?v=EKvvptbTx6k](https://www.youtube.com/watch?v=EKvvptbTx6k)

# CRA to Vite Migration

## base

- **Remove CRA package for Vite**
  ê¸°ì¡´ CRA í™˜ê²½ì—ì„œ ì‚¬ìš©ë˜ëŠ” íŒ¨í‚¤ì§€ ì‚­ì œ
  ê¸°ì¡´ì— ì„¤ì¹˜ëœ node_modulesê°€ ìˆëŠ”ê²½ìš° í´ë” ìì²´ë¥¼ ì‚­ì œ

  ```bash
  yarn remove react-scripts react-app-rewired babel-loader webpack-merge tsconfig-paths-webpack-plugin

  rm -rf node_modules
  ```

- **Setting the Stage with Vite Installation**
  **vite: ëª¨ë˜ ì›¹ í”„ë¡œì íŠ¸ ë¹Œë“œ ë„êµ¬**

  - @vitejs/plugin-react: @vitejs/plugin-reactëŠ” viteì—ì„œ Reactë¥¼ ì‚¬ìš©í•  ë•Œ í•„ìš”í•œ êµ¬ì„±ì„ ì¶”ê°€í•˜ì—¬ React ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¹ ë¥¸ ê°œë°œ ë° ë²ˆë“¤ë§ì„ ì§€ì›
  - vite-tsconfig-paths: tsconfig.json íŒŒì¼ì— ì„¤ì •ëœ ê²½ë¡œ ë³„ì¹­ì„ Viteì—ì„œë„ ì ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›. vite-tsconfig-pathsë¥¼ ì‚¬ìš©í•˜ë©´ TypeScript ì„¤ì •ì— ì •ì˜ëœ ê²½ë¡œ ë³„ì¹­ì´ Viteì—ì„œë„ ì¸ì‹ë˜ì–´ ëª¨ë“ˆ ê²½ë¡œë¥¼ í•´ì„í•  ë•Œ ì‚¬ìš© ê°€ëŠ¥
  - vite-plugin-svgr
    - SVGë¥¼ React ì»´í¬ë„ŒíŠ¸ë¡œ ë³€í™˜í•˜ëŠ” Vite í”ŒëŸ¬ê·¸ì¸
    - ë‹¨, 3.3.0 ì´í›„ ë²„ì „ ì„¤ì¹˜ ì‹œ ë¹Œë“œ, íƒ€ì… ì—ëŸ¬ ë°œìƒ(3.3.0 ì‚¬ìš© ì‹œ ì•„ë˜ì™€ ê°™ì€ svgrì„ ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ë¡œ ë³€ê²½ ê°€ëŠ¥)
    ```bash
    import { ReactComponent as ChannelLogo } from '../../assets/artwork-illust-pm-assign-info-channel-talk.svg';
    ```
  - vite-plugin-checker
    - viteë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì íŠ¸ì—ì„œ íƒ€ì… ì²´í¬, ESLint, VLS (Volar Language Server) ë“±ì„ í¬í•¨í•œ ì—¬ëŸ¬ ê²€ì‚¬ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” í”ŒëŸ¬ê·¸ì¸
    - ë¹„ë™ê¸°ë¡œ ì²´í¬ë¥¼ í•˜ê¸° ë•Œë¬¸ì— ê°œë°œ ì„œë²„ í™˜ê²½ ë¡œë”© ì†ë„ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ” ì¥ì ì´ ìˆë‹¤.

  ```
  yarn add vite @vitejs/plugin-react vite-tsconfig-paths vite-plugin-svgr@3.3.0

  yarn add vite-plugin-checker -D
  ```

- **Updating package.json for Vite Commands**
  ```bash
  scripts": {
    "start": "vite", // dev-server
    "build": "vite build", // build
  },
  ```
- **Renaming React File Extensions to .jsx or .tsx**
  React JSX ë¬¸ë²•ì„ ì‚¬ìš©í•˜ëŠ” íŒŒì¼ì— ëŒ€í•´ì„œë§Œ, jsx/tsxë¡œ ë³€ê²½í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.
  ```bash
  mv src/App.js src/App.jsx
  mv src/index.ts src/index.tsx
  ```
- **Move the index.html File**
  - public íŒ¨ìŠ¤ì˜ index.html ì‚­ì œí•˜ì§€ ì•Šì„ ê²½ìš° viteì—ì„œ ê°œë°œ í™˜ê²½ ë¡œë”© ì‹œ public/index.html ì„  ë¡œë”©í•¨ìœ¼ë¡œ ê¼­ ë£¨íŠ¸ë¡œ ì˜®ê²¨ì£¼ì„¸ìš”!!
  ```bash
  mv public/index.html .
  ```
- **Add module script to the bottom of the body tag**
  ì´ˆê¸° ë¡œë”© ì‹œ ì½”ë“œ ì§„ì…ì ì„ ëª…ì‹œí•´ì£¼ì„¸ìš”.
  ```html
  <body>
    {/* others here */}
    <script type="module" src="/src/index.tsx"></script>
  </body>
  ```
- **Update tsconfig.json**
  isolatedModules ì‚¬ìš©ì´ìœ 
  - **ëª¨ë“ˆ ê°„ì˜ ì˜ì¡´ì„± ê²©ë¦¬**: ê° ëª¨ë“ˆì´ ì„œë¡œì˜ íƒ€ì…ì— ì˜ì¡´í•˜ì§€ ì•Šë„ë¡ í•˜ì—¬, ì»´íŒŒì¼ ì‹œ ëª¨ë“ˆì„ ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ TypeScriptì˜ ì»´íŒŒì¼ ì‹œê°„ì´ ì¤„ì–´ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - **ì„±ëŠ¥ í–¥ìƒ**: ë…ë¦½ì ìœ¼ë¡œ ëª¨ë“ˆì„ ì»´íŒŒì¼í•˜ë©´, ë³€í™”ê°€ ë°œìƒí•œ ëª¨ë“ˆë§Œ ë‹¤ì‹œ ì»´íŒŒì¼ë˜ë¯€ë¡œ ì „ì²´ ì»´íŒŒì¼ ì†ë„ê°€ ê°œì„ ë©ë‹ˆë‹¤.
  - **ESM í˜¸í™˜ì„±**: ES ëª¨ë“ˆê³¼ì˜ í˜¸í™˜ì„±ì„ ë†’ì—¬, ë‹¤ì–‘í•œ ë¹Œë“œ ë„êµ¬ì™€ì˜ í†µí•© ì‹œ ë” ë‚˜ì€ ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
  - **ê²€ì‚¬ ì˜¤ë¥˜ ë°©ì§€**: ëª¨ë“  ëª¨ë“ˆì´ ê°œë³„ì ìœ¼ë¡œ ì²´í¬ë˜ë¯€ë¡œ, í•œ ëª¨ë“ˆì—ì„œì˜ íƒ€ì… ì˜¤ë¥˜ê°€ ë‹¤ë¥¸ ëª¨ë“ˆì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ê²ƒì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    includeì— vite.config.js íŒ¨ìŠ¤ ì„¤ì •
  ```bash
  {
    "extends": "./tsconfig.extend.json",
    "compilerOptions": {
      "lib": ["dom", "dom.iterable", "es2020"],
      "target": "ES6",
      "types": ["vite/client", "react", "react-dom", "node"],
      "isolatedModules": true // ì¶”ê°€
    },
    "include": [
      "./src/**/*",
      "vite.config.js"
    ],
    "exclude": [
      "node_modules"
    ]
  }
  ```
- **Add module html minify**
  CRA í”„ë¡œì íŠ¸ì—ì„œëŠ” ë‚´ì¥ëœ pluginsì¤‘ì— HtmlWebpackPlugin í†µí•´ì„œ html minifyë¥¼ í•´ì£¼ê³  ìˆëŠ”ë°, viteì—ì„œ ë‚´ì¥ì´ ë˜ì–´ ìˆì§€ ì•Šì•„ì„œ ì§ì ‘ ì„¤ì¹˜í›„ì— í™˜ê²½ ì„¤ì •ì„ ì¶”ê°€í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

  ```bash
  // Installation
  yarn add vite-plugin-html

  // vite.config.js
  createHtmlPlugin({
    // input <https://www.npmjs.com/package/html-minifier-terser> options
    minify: true,
  }),
  ```

## Configuration

- **Crafting the Vite Configuration**

  ```tsx
  // <root>/vite.config.js
  import { defineConfig, loadEnv } from 'vite';
  import path from 'path';
  import react from '@vitejs/plugin-react';
  import viteTsconfigPaths from 'vite-tsconfig-paths';
  import svgr from 'vite-plugin-svgr';
  import { createHtmlPlugin } from 'vite-plugin-html';
  import checker from 'vite-plugin-checker';

  export default defineConfig(config => {
    const env = loadEnv(config.mode, process.cwd(), '');

    return {
      build: {
        outDir: 'build', // build í´ë”ëª… ë³€ê²½(ê¸°ë³¸ dist)
        target: 'es2015', // es6 target transpile
        sourcemap: false, // ì†ŒìŠ¤ë§µ ìƒì„± ì—¬ë¶€
        rollupOptions: {
          output: {
            manualChunks(id) {
              // chunks íŒŒì¼ì„ ë§Œë“¤ ê²½ìš° ì•„ë˜ì™€ ê°™ì´ ì²­í¬ëª…ê³¼ í•„í„°ë¥¼ ê±¸ì–´ì£¼ì„¸ìš”.
              if (id.includes('/react')) {
                return 'venders';
              }
            },
          },
          onwarn(warning, defaultHandler) {
            // sourcemap: true ì„¤ì •í•  ê²½ìš° node_modulesì— ì†ŒìŠ¤ë§µ ì—†ëŠ” ê²½ìš°ì— ëŒ€í•œ ê²½ê³  ë¬´ì‹œë¥¼ ìœ„í•´ ì¶”ê°€
            if (warning.code === 'SOURCEMAP_ERROR') {
              return;
            }
            defaultHandler(warning);
          },
        },
      },
      define: {
        global: 'globalThis', // ê¸€ë¡œë²Œ ê°ì²´ë¥¼ ë¹ˆ ê°ì²´ë¡œ ëŒ€ì²´(globalÂ is not defined error ì—ëŸ¬ì— ëŒ€í•œ ë°©ì–´ì½”ë“œ)
      },
      plugins: [react(), viteTsconfigPaths(), svgr()],
    };
  });
  ```

## Environment Variables

- VITEë¼ëŠ” prefixë¥¼ ì„¤ì •í•˜ì§€ ì•Šì„ ê²½ìš° import.meta.env ì—ì„œ ê°’ì„ ì–»ì–´ ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- ê¸°ë³¸ì ìœ¼ë¡œ ì†ì„±ê°’ìœ¼ë¡œ DEV(vite), PROD(vite build)ì„ ì œê³µí•´ì¤Œìœ¼ë¡œ ê°œë°œ/ë¹Œë“œ í™˜ê²½ êµ¬ë¶„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- **ChangeEnv Variables and Modes**

  ```json
  // .env Files
  .env                # loaded in all cases
  .env.local          # loaded in all cases, ignored by git
  .env.[mode]         # only loaded in specified mode
  .env.[mode].local   # only loaded in specified mode, ignored by git

  // Modes
  # .env.production.live
  VITE_ENVIRONMENT=live

  // command mode option flag
  "build:dev": "yarn vite --mode production.dev",
  "build:rc": "yarn vite --mode production.rc",
  "build:live": "yarn vite --mode production.live",
  ```

- **Update process.env.REACT_APP**
  ```tsx
  -process.env.REACT_APP_VARIABLE + import.meta.env.VITE_VARIABLE;
  ```

## EJS Variables

- **Update Configuration for Vite**
  ë¹Œë“œ ì‹œ HTML CJS ë¬¸ë²•ì´ ì¹˜í™˜ë˜ë„ë¡ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œ vite-plugin-html ì´ìš©í•´ì„œ ë‚´ë³´ë‚´ê¸° ì²˜ë¦¬ ì¶”ê°€
  ```
  createHtmlPlugin({
    ....
    inject: {
      data: {
        VITE_VARIABLE: env.VITE_VARIABLE,
      },
    },
  }),
  ```
- **Replace EJS Variables for Vite**
  ë¬¸ìë§Œ ì¹˜í™˜í•  ê²½ìš°

  - â€œ%â€ â†’ â€œ<%= ~~ =>â€
  - ì˜ˆ) <script src="/variable"></script> â†’ ë¬¸ìì•ˆì— ê¸€ìë¥¼ ì¹˜í™˜í•  ê²½ìš°

  ```html
  // env VITE_VARIABLE='/variable' //
  <root
    >/index.html //// CRA
    <script src="%REACT_APP_VARIABLE%"></script>

    //// VITE
    <script src="<%= VITE_VARIABLE %>"></script
  ></root>
  ```

  ì—˜ë¦¬ë¨¼íŠ¸(íƒœê·¸) ìì²´ë¥¼ ë³€ê²½í•  ê²½ìš°

  - % â†’ <%- ~~ ->

  ```
   // env
  VITE_SCRIPT=<script>(function ~~ )</script>

  // <root>/index.html
  //// CRA
  %VITE_SCRIPT%

  //// VITE
  <%- VITE_SCRIPT %>
  ```

- **Updating Vite Commands(with enviroment)**
  ```json
  "start": "vite",
  "start:dev": "yarn start --mode development.dev",
  "start:rc": "yarn start --mode development.rc",
  "build": "vite build",
  "build:dev": "yarn build --mode production.dev",
  "build:rc": "yarn build --mode production.rc",
  "build:live": "yarn build --mode production.live",
  ```

## Vite Lint, Typescript Checker

- **Add module vite-plugin-checker**
  CRA í™˜ê²½ì—ì„œ ë‚´ë¶€ì ìœ¼ë¡œ fork-ts-checker-webpack-plugin í”ŒëŸ¬ê·¸ì¸ì„ ë°”íƒ•ìœ¼ë¡œ ë¹„ë™ê¸°ë¡œ íƒ€ì… ì²´í¬ë¥¼ í•´ì£¼ê³  ìˆì§€ë§Œ, VITE í™˜ê²½ì—ì„œëŠ” vite-plugin-checker ì§ì ‘ ì„¤ì¹˜ í›„ vite.config.js êµ¬ì„±ì— ì¶”ê°€í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

  ```tsx
  // vite.config.js
  import checker from 'vite-plugin-checker';

  checker({
    typescript: config.mode.indexOf('development') > -1,
    eslint: config.mode.indexOf('development') > -1 ? {
      lintCommand: 'eslint "./src/**/*.{ts,tsx,js,jsx}"',
    } : false,
    stylelint: config.mode.indexOf('development') > -1 ? {
      lintCommand: 'stylelint "src/**/*.scss"'
    } : false,
  }),
  ```

# CRA to Vite Migration Tip

- **import.meta.glob dynamic load**
  Viteì˜ import.meta.globì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì•„ì´ì½˜ì„ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ```tsx
  const icons = import.meta.glob('./*Icon.tsx');

  const iconComponentPath = './aIcon.tsx';

  const Icon =
    icons && icons[iconComponentPath as string]
      ? lazy(
          () =>
            icons[iconComponentPath as string]() as Promise<{
              default: ComponentType;
            }>,
        )
      : null;
  ```

- **sass-resources-loader(dart sass) â†’ vite config preprocessorOptions.sass**
  ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ìŠ¤íƒ€ì¼ì„ ì „ì—­ì ìœ¼ë¡œ ì ìš©í•  ë•Œ ì‚¬ìš©í•˜ëŠ” sass-resources-loaderë¥¼ viteì—ì„œëŠ” preprocessorOptions.sassë¡œ ëŒ€ì²´ê°€ ê°€ëŠ¥

  ```tsx
  // CRA
  rules: [
    {
      test: /\\.scss$/,
      use: [
        {
          loader: 'sass-resources-loader',
          options: {
            resources: [
              path.resolve(__dirname, './sass.scss'),
            ],
          },
        },
      ],
      include: path.resolve(__dirname, './src'),
      exclude: /node_modules/,
    },
  ]

  // vite.config.js
  css: {
    preprocessorOptions: {
      scss: {
        // Next line will prepend the import in all you scss files as you did with your vite.config.js file
        additionalData: `
          @import "./sass.scss";
        `,
      },
    },
  },
  ```

  **ë‹¨ê³„ë³„ ì—ëŸ¬ ì¼€ì´ìŠ¤ ì •ë¦¬**
  @forward rules must be written before any other rules ì—ëŸ¬

  - @forward êµ¬ë¬¸ì´ ë‹¤ë¥¸ ëª¨ë“  ê·œì¹™(@import, @use, ìŠ¤íƒ€ì¼ ì„ ì–¸) ë³´ë‹¤ ìœ„ì— ìœ„ì¹˜í•˜ë„ë¡ ìˆ˜ì •
    @forward
  - Dart Sassì—ì„œ ë„ì…ëœ Sass ëª¨ë“ˆ ì‹œìŠ¤í…œì˜ ì¼ë¶€ë¡œ, ëª¨ë“ˆí™”ëœ ìŠ¤íƒ€ì¼ì‹œíŠ¸ë¥¼ êµ¬ì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë° ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.
  - @import ë°©ì‹ê³¼ëŠ” ë‹¤ë¥´ê²Œ, @forwardëŠ” Sass ì½”ë“œì˜ ëª¨ë“ˆí™”ì™€ ì¬ì‚¬ìš©ì„±ì„ ë” ì‰½ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë•ìŠµë‹ˆë‹¤.
    @use: ëª¨ë“ˆì„ ê°€ì ¸ì˜¤ë©´ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•´ ì¶©ëŒì„ ë°©ì§€í•˜ê³ , ëª…ì‹œì ìœ¼ë¡œ í•„ìš”í•œ ë¶€ë¶„ë§Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    @importëŠ” íŒŒì¼ì„ ë‹¨ìˆœíˆ í¬í•¨í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ, ì—¬ëŸ¬ ë²ˆ í¬í•¨ë  ìˆ˜ ìˆê³  ë³€ìˆ˜ë‚˜ ë¯¹ìŠ¤ì¸ì˜ ì¶©ëŒ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.

  ```tsx
  // reset.scss
  @forward 'reset';

  // ./sass.scss
  @use 'color';

  css: {
    preprocessorOptions: {
      scss: {
        // Next line will prepend the import in all you scss files as you did with your vite.config.js file
        additionalData: `
          @forward 'reset';

          @use './color.scss' as *;
          @use './sass.scss' as *
        `,
      },
    },
  },
  ```

- **setting module scss name for Vite(ì„ íƒ)**
  CRAì—ì„œëŠ” SCSS ëª¨ë“ˆì„ ì‚¬ìš©í•  ë•Œ, íŒŒì¼ëª…ê³¼ í´ë˜ìŠ¤ëª…ì„ ê²°í•©í•´ ê³ ìœ í•œ í´ë˜ìŠ¤ëª…ì„ ìë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ë§Œ, VITE ì—ì„œëŠ” í´ë˜ìŠ¤ëª…ìœ¼ë¡œë§Œ ìƒì„±ë˜ëŠ” ê·œì¹™ì„ ë‹¤ë¥´ê²Œ ê°€ì ¸ê°€ê³  ìˆìŒ

  - ê·œì¹™: [íŒŒì¼ëª…]_[ì›ë˜ í´ë˜ìŠ¤ëª…]_[hash:base64:5]
    ë‹¨, ì„œë¹„ìŠ¤ ë‚´ì—ì„œ module scssë¥¼ ì „ì—­ìœ¼ë¡œ ì„ íƒí•˜ëŠ” ê²½ìš°ê°€ ì—†ë‹¤ë©´ êµ³ì´ ì„¸íŒ…ì„ í•´ì¤„ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.(ë‚´ë¶€ì ìœ¼ë¡œëŠ” ì„¸íŒ…ì„ í•˜ì§€ ì•Šì„ ì‹œ [í´ë˜ìŠ¤ëª…, hash]ê°’ì„ í† ëŒ€ë¡œ ìœ ë‹ˆí¬í•œ ê°’ìœ¼ë¡œ ìë™ ë³€ê²½)

  ```tsx
  import styles from './Test.module.scss';

  const Test = () => {
  	return (
  		<div className={styles.container}></div>
  	);
  };

  export default Test;

  // ë³€ê²½ ì „
  class="Test_container__28qL6"

  // ë³€ê²½ í›„
  //// vite.config.js
  const namespaceUUID = v4();
  css: {
    ...
    modules: {
      // íŒŒì¼ëª…ê³¼ í´ë˜ìŠ¤ëª…ì„ í¬í•¨í•œ ê³ ìœ í•œ ì´ë¦„ ìƒì„±
      generateScopedName: (name, filename) => {
        // íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ ê³ ìœ í•œ í•´ì‹œ ìƒì„±
        const file = path.basename(filename).replace('.module', '').replace(/\.[^/.]+$/, '');

        // UUID ìƒì„± í›„ Base64 ì¸ì½”ë”©
        const hash = Buffer.from(v5(`${file}_${name}`, namespaceUUID)).toString('base64').slice(0, 5);
        return `${file}_${name}__${hash}`;
      },
    },
  },
  ```

- **server(proxy, outside file)**
  CRA proxy ì„¤ì •ì„ VITE proxyë¡œ ëŒ€ì²´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
  VITE í™˜ê²½ ì™¸ì— ì™¸ë¶€ í´ë”/íŒŒì¼ ì ‘ê·¼ ì‹œ fs.allow ê°ì²´ë¡œ ì¶”ê°€ ì‹œ dev serverì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
  ê¸°ì¡´ì—ëŠ” proxy íŒ¨ìŠ¤ë¥¼ ë°°ì—´ë¡œ ê´€ë¦¬í–ˆì§€ë§Œ viteì—ì„œëŠ” ê°ê° íŒ¨ìŠ¤ë¡œ ê´€ë¦¬ë¥¼ í•´ì¤˜ì•¼í•©ë‹ˆë‹¤.

  ```tsx
  // CRA
  //// ê¸°ì¡´ íŒ¨í‚¤ì§€ ì‚­ì œ
  yarn remove http-proxy-middleware

  //// setupProxy.js
  // ìˆ˜ì • ì „
  const { createProxyMiddleware } = require('http-proxy-middleware');
  module.exports = function setupProxy(app) {
    app.use(createProxyMiddleware(['/test'], {
      changeOrigin: true,
  	  logLevel: 'debug',
  	  autoRewrite: true,
      target: 'http://www.test.kr',
      onProxyRes: (proxyRes) => {
        console.log(proxyRes);
      }),
      onProxyReq: (proxyReq) => {
        proxyReq.setHeader('origin', 'http://www.test.kr');
      },
    }));

  // vite.config.js
  //// ìˆ˜ì • í›„
  const env = loadEnv(config.mode, process.cwd(), '');
  server: {
  	proxy: {
  		fs: {
  	    // í—ˆìš©í•  ë””ë ‰í„°ë¦¬ ì¶”ê°€ (ì—¬ê¸°ì— ì™¸ë¶€ íŒŒì¼ ê²½ë¡œë¥¼ ì¶”ê°€)
  	    allow: [
  	      '../../../outside',
  	      '/'
  	    ],
  	  },
  		'/test': {
  	    changeOrigin: true,
  		  logLevel: 'debug',
  		  autoRewrite: true,
  	    target: 'http://www.test.kr',
  	    configure: (proxy) => {
  	      proxy.on('proxyRes', (proxyRes, env) => {
  	        console.log(proxyRes);
  	      }),
  	      proxy.on('proxyReq', (proxyReq, env) => {
  	        proxyReq.setHeader('origin', 'http://www.test.kr');
  	      });
  	    },
  	  },
  	},
  },
  ```

- **external file link settings(alias)**
  CRAì—ì„œ ì™¸ë¶€ íŒŒì¼ë‚´ì— íŒ¨ìŠ¤(tsconfig.json)ë¥¼ ì ‘ê·¼ ì‹œ í˜„ì¬ í”„ë¡œì íŠ¸ í™˜ê²½ ê¸°ì¤€ìœ¼ë¡œ íŒ¨ìŠ¤ë¥¼ ë°”ë¼ë³´ì§€ë§Œ,
  VITEì—ì„œëŠ” ì™¸ë¶€ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ íŒ¨ìŠ¤ë¥¼ ì ‘ê·¼í•˜ë‹¤ë³´ë‹ˆ alias ì²˜ë¦¬ì— ì´ìŠˆê°€ ìˆì–´ì„œ tsconfig pathê°€ ì•„ë‹Œ ì ˆëŒ€ ê²½ë¡œ íŒ¨ìŠ¤ë¡œ ì¬ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.
  ì˜ˆ)

  - CRA(root)
    - outside/index.tsx ì»´í¬ë„ŒíŠ¸ ìœ„ì¹˜ ê¸°ì¤€
  - VITE
    - root ìœ„ì¹˜ ê¸°ì¤€

  ```tsx
  // CRA
  const modifiedConfig = aliasWebpack({
    tsconfig: path.resolve(__dirname, './tsconfig.json'),
  })(config);

  // vite.config.js
  resolve: {
    alias: {
      '@outside': path.join(__dirname, '../outside'),
    },
  },

  // outside/index.tsx
  import Button from '../Button';
  ```

- **setting external file access permissions**
  CRAì—ì„œëŠ” ì™¸ë¶€íŒŒì¼ ì ‘ê·¼ ì‹œ ë‚´ë¶€ config íŒŒì¼ì—ì„œ ModuleScopePlugin í”ŒëŸ¬ê·¸ì¸ì— ì¶”ê°€í•´ì£¼ëŠ” ë²ˆê±°ë¡œì›€ì´ ìˆì—ˆì§€ë§Œ,
  VITEì—ì„œëŠ” ë¹Œë“œ ê³¼ì •ì—ì„œëŠ” ì™¸ë¶€ íŒŒì¼ ì ‘ê·¼ì´ ììœ ë¡œìš°ë‚˜, ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì™¸ë¶€ íŒŒì¼ íŒ¨ìŠ¤ ê²½ë¡œë¥¼ ì„¤ì •í•´ì¤˜ì•¼í•©ë‹ˆë‹¤.
  - ë‹¨, íŒŒì¼ íŒ¨ìŠ¤ ì„¤ì • ì‹œ ì™¸ë¶€ íŒŒì¼ íŒ¨ìŠ¤ì™¸ì— ë‚´ë¶€ íŒŒì¼ íŒ¨ìŠ¤ë„ ê°™ì´ ì„¤ì •í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
  ```tsx
  fs: {
    // í—ˆìš©í•  ë””ë ‰í„°ë¦¬ ì¶”ê°€ (ì—¬ê¸°ì— ì™¸ë¶€ íŒŒì¼ ê²½ë¡œë¥¼ ì¶”ê°€)
    allow: [
      '../outside',
      '/'
    ],
  },
  ```
- **setting baseurl for Vite**
  CRAì—ì„œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ BaseURL(PUBLIC_URL)ì„ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ íŒ¨ìŠ¤ ê²½ë¡œë¥¼ ì„¤ì •í•´ì£¼ì§€ë§Œ, VITEì—ì„œëŠ” í•´ë‹¹ ê²½ë¡œë¥¼ base ì†ì„±ê°’ìœ¼ë¡œ ë³€ê²½í•´ì¤˜ì•¼í•©ë‹ˆë‹¤.(env í™˜ê²½ ë³€ìˆ˜ì— base url íŒ¨ìŠ¤ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”.)
  ë‹¨, DEV í™˜ê²½ì—ì„œëŠ” ë‚´ë¶€ ë¦¬ì†ŒìŠ¤ íŒ¨ìŠ¤ë¡œ ì„¤ì •í•´ì•¼í•¨ìœ¼ë¡œ íŒ¨ìŠ¤ë¥¼ ì§€ì •í•˜ì§€ ë§ì•„ì•¼í•©ë‹ˆë‹¤.

  ```html
  // CRA //// index.html
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico" />
  </head>

  // VITE //// env.production.dev VITE_PUBLIC_URL=https://test ////
  vite.config.js base: env.VITE_PUBLIC_URL || '/', //// index.html
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="/favicon.ico" />
  </head>

  //// index.html(ê²°ê³¼ë¬¼)
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="https://test/favicon.ico" />
  </head>
  ```

-

# CRA to Vite Migration Storybook

- **Installation**
  ì´ì „ ë²„ì „ Storybook ì‚­ì œ
  ```bash
  yarn remove @storybook/addon-*(knobs, controls ë“±ë“±)
  ```
  vite ì—°ë™ì„ ìœ„í•œ ìŠ¤í† ë¦¬ë¶ íŒ¨í‚¤ì§€ ì¶”ê°€
  ê¸°ì¡´ CRA í™˜ê²½ì—ì„œëŠ” @storybook/react íŒ¨í‚¤ì§€ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì„œ ë¬¸ì œê°€ ì—†ì—ˆì§€ë§Œ,
  VITEì—ì„œëŠ” @storybook/react-vite íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ë©´ì„œ storybook íŒ¨í‚¤ì§€ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.
  ë˜í•œ, storybook ì—°ë™ íŒ¨í‚¤ì§€ê°€ 6ë²„ì „ ì‚¬ìš© ì‹œ â€˜storybook-channel-mock.js:7 Uncaught TypeError: import_channels.default is not a constructorâ€™ ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.
  ê¼­ ìµœì‹  ë²„ì „ì¸ 8ë²„ì „ ì´ìƒì— íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜ë¥¼ í•´ì£¼ì„¸ìš”
  ```bash
  yarn add @storybook/builder-vite @storybook/react @storybook/react-vite storybook -D
  ```
  Major breaking changes
  - [Node 18+ is now required](https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#dropping-support-for-nodejs-16)
  - [Addons API introduced in Storybook 7 is now required](https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#new-addons-api)
  - vite í™˜ê²½ì¼ ê²½ìš° root íŒ¨ìŠ¤ì— vite.config.jsê°€ í•„ìˆ˜ë¡œ ì¶”ê°€
- **setting**
  .storybook/main
  addon ì„¤ì •

  ```tsx
   addons: [
    '@storybook/addon-links',
    '@storybook/addon-essentials',
  ],
  ```

  builder, framework ì§€ì •

  ```tsx
  core: {
    builder: '@storybook/builder-vite', // ğŸ‘ˆ The builder enabled here.
  },
  framework: '@storybook/react-vite',
  ```

  base static path ì§€ì •

  ```tsx
  // CRA - @storybook/react
  "storybook": "start-storybook -p 9009 -s public",

  // VITE - @storybook/vite
  staticDirs: ['../public'], // ì´ì „ ë²„ì „(v6) -s public ì˜µì…˜ê³¼ ë™ì¼
  ```

  webpackFinal â†’ ViteFinal ë§ˆì´ê·¸ë ˆì´ì…˜

  - preprocess scss, í—ˆìš©í•  íŒŒì¼ íŒ¨ìŠ¤ ì—°ë™

  ```tsx
  // webpack
  config.module.rules.push({
    test: /\.scss$/,
    use: [
      {
        loader: 'sass-resources-loader',
        options: {
          resources: [path.resolve(__dirname, '../sass.scss')],
        },
      },
    ],
    include: path.resolve(__dirname, '../src'),
    exclude: /node_modules/,
  });

  // Vite
  const { mergeConfig } = await import('vite');
  return mergeConfig(config, {
    // Merge custom configuration into the default config
    const { mergeConfig } = await import('vite');
    css: {
      preprocessorOptions: {
        scss: {
        // Next line will prepend the import in all you scss files as you did with your vite.config.js file
        additionalData: `
          @forward 'reset';

          @use './color.scss' as *;
          @use './sass.scss' as *
        `,
  	    },
      },
    },
  ```

  - ì™¸ë¶€ íŒŒì¼ ì ‘ê·¼

  ```tsx
  // VITE
  server: {
    fs: {
      // í—ˆìš©í•  ë””ë ‰í„°ë¦¬ ì¶”ê°€ (ì—¬ê¸°ì— ì™¸ë¶€ íŒŒì¼ ê²½ë¡œë¥¼ ì¶”ê°€)
      allow: [
        '../outside',
        '/'
      ],
    },
  },
  ```

- **storybook code migration processing**
  **No longer inferring default values of args(v6.3)**
  ë²„ì „ ì—…ë°ì´íŠ¸ê°€ ë˜ë©´ì„œ argTypesì—ì„œ ê¸°ë³¸ê°’ ì„¸íŒ…ì„ í•  ìˆ˜ ì—†ê³  argsì—ì„œ ì„¸íŒ…í•˜ëŠ”ê±¸ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹Œë“œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§„ ì•Šì§€ë§Œ, í™•ì¸í•´ë³´ì‹œë©´ undefined ì„¤ì •ë˜ì„œ ë“¤ì–´ê°€ê²Œ ë˜ë‹ˆ ê¼­ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ë³€ê²½ í•´ì£¼ì„¸ìš”.

  ```tsx
  // CRA - storybook
  argTypes: {
    isModalOpened: {
      name: 'ëª¨ë‹¬ ì˜¤í”ˆì—¬ë¶€',
      defaultValue: true,
      control: {
        type: 'boolean',
      },
    },
  },

  // VITE - storybook
  argTypes: {
    isModalOpened: {
      name: 'ëª¨ë‹¬ ì˜¤í”ˆì—¬ë¶€',
      control: 'boolean',
    },
  },
  args: {
    isModalOpened: true,
  },
  ```

  **New parameters format for addon viewport(v8.3)**

  - viewports â†’ options ë³€ê²½

  ```tsx
  // ì´ì „
  export const parameters = {
    viewport: {
      viewports: {
        iphone5: {
          name: 'phone',
          styles: {
            width: '320px',
            height: '568px',
         },
       },
     },
  }

  // ë³€ê²½ í›„
  export const parameters = {
    viewport: {
      options: {
        iphone5: {
          name: 'phone',
          styles: {
            width: '320px',
            height: '568px',
         },
       },
     },
  }
  ```

  **Story type deprecated(v7.0)**

  ```tsx
  // ë³€ê²½ ì „
  import type { Story } from '@storybook/react';

  export const MyStory: Story = () => <div />;

  // ë³€ê²½ í›„
  import type { StoryFn, StoryObj } from '@storybook/react';

  export const MyCsf2Story: StoryFn = () => <div />;
  export const MyCsf3Story: StoryObj = {
    render: () => <div />,
  };
  ```

  **start-storybook / build-storybook binaries removed(v7.0)**

  ```bash
  // ë³€ê²½ ì „
  {
    "scripts": {
      "storybook": "start-storybook <some flags>",
      "build-storybook": "build-storybook <some flags>"
    }
  }

  // ë³€ê²½ í›„
  {
    "scripts": {
      "storybook": "storybook dev <some flags>",
      "build-storybook": "storybook build <some flags>"
    },
    "devDependencies": {
      "storybook": "next"
    }
  }
  ```

  **Ignore story files from node_modules(v7.0)**

  - ê¸°ë³¸ì ìœ¼ë¡œ node_modules ì•ˆì— ìŠ¤í† ë¦¬ë¶ì€ ë¬´ì‹œí•˜ë„ë¡ ë³€ê²½

  ```tsx
  export default {
    stories: ["../**/*.stories.*"],
  };

  // ê¸°ì¡´ glob.sync ì²˜ë¦¬ëŠ” êµ³ì´ ì•ˆí•´ì¤˜ë„ ë©ë‹ˆë‹¤.
  // const getStories = () => glob.sync(`${path.resolve(__dirname, '../')}/src/**/*.stories.@(js|jsx|ts|tsx)`);
  // stories: async () => getStories(),

  // í€ë”© ìŠ¤íŠœë””ì˜¤ ì ìš©
  stories: ["../src/**/*.stories.@(js|jsx|ts|tsx)"],
  ```

  **Removed deprecated shim packages(v8.0)**
  | Removal | Replacement |
  | ------------------------------ | ------------------------------------------------- |
  | @storybook/addons | @storybook/manager-api or @storyboook/preview-api |
  | @storybook/channel-postmessage | @storybook/channels |
  | @storybook/channel-websocket | @storybook/channels |
  | @storybook/client-api | @storybook/preview-api |
  | @storybook/core-client | @storybook/preview-api |
  | @storybook/preview-web | @storybook/preview-api |
  | @storybook/store | @storybook/preview-api |
  | @storybook/api | @storybook/manager-api |
  | @storybook/testing-library | @storybook/test |
  **Deprecated addon-knobs(v6.3) â†’ staticìª½ë„ ë²„ì „ ì—…í•˜ì‹œë ¤ë©´ ìˆ˜ì •ì„ í•´ì£¼ì…”ì•¼í•©ë‹ˆë‹¤.**
  addon-essentials íŒ¨í‚¤ì§€ ì„¤ì¹˜ í›„ knobsê°€ ì•„ë‹Œ controlì„ ì‚¬ìš©

  1. **Controls (**@storybook/addon-controls**)**: ì»´í¬ë„ŒíŠ¸ì˜ propsë¥¼ UIì—ì„œ ì œì–´í•  ìˆ˜ ìˆë„ë¡ í•´ì¤ë‹ˆë‹¤.
  2. **Actions (**@storybook/addon-actions**)**: ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ë””ë²„ê¹…í•˜ê¸° ì‰½ê²Œ ë¡œê·¸ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
  3. **Docs (**@storybook/addon-docs**)**: ì»´í¬ë„ŒíŠ¸ì˜ ë¬¸ì„œë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
  4. **Viewport (**@storybook/addon-viewport**)**: ë‹¤ì–‘í•œ í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ì»´í¬ë„ŒíŠ¸ì˜ ë™ì‘ì„ í™•ì¸í•©ë‹ˆë‹¤.
  5. ê¸°íƒ€ ì• ë“œì˜¨ë“¤ (e.g., Backgrounds, Toolbars & Icons ë“±).
     [https://github.com/storybookjs/storybook/blob/next/MIGRATION.md](https://github.com/storybookjs/storybook/blob/next/MIGRATION.md)

- **package.json storybook command**

  ```json
  // CRA
  "storybook": "start-storybook -p 9009 -s public",
  "build-storybook": "build-storybook -s public -o .storybook/build --quiet",

  // VITE
  "storybook": "storybook dev -p 9009",
  "build-storybook": "storybook build -o .storybook/build --quiet"
  ```

# Jest to Vitest Migration

- **Why Vitest is better than Jest**
  1. **ë¹ ë¥¸ ì„±ëŠ¥**: esbuild ê¸°ë°˜ìœ¼ë¡œ Jestë³´ë‹¤ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰.(jest: Babel)
  2. **ESM ì§€ì›**: ìµœì‹  ES ëª¨ë“ˆì„ ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì›.(ES ë°©ì‹ ì§€ì› ê°€ëŠ¥í•˜ë‚˜ í˜¸í™˜ì„± ì´ìŠˆ ë°œìƒ)
  3. **íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ í†µí•©**: ì¶”ê°€ ì„¤ì • ì—†ì´ TypeScriptì™€ ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©.
  4. **ê°„ë‹¨í•œ ëª¨í‚¹ API**: ì§ê´€ì ì´ê³  ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” mocking ê¸°ëŠ¥ ì œê³µ.
  5. **Viteì™€ì˜ í˜¸í™˜ì„±**: Vite ì„¤ì • ë° í”ŒëŸ¬ê·¸ì¸ì„ ê·¸ëŒ€ë¡œ í™œìš©.
  6. **í˜„ëŒ€ì  ê¸°ëŠ¥**: HMRê³¼ ë¹ ë¥¸ watch ëª¨ë“œ ì§€ì›.
  7. **ì‘ì€ í•™ìŠµ ê³¡ì„ **: Vite ì‚¬ìš©ìì—ê²Œ ì¹œìˆ™í•œ ì„¤ì •.
  8. **ìš°ìˆ˜í•œ ê°œë°œì ê²½í—˜**: ì˜¤ë¥˜ ë³´ê³  ë° í…ŒìŠ¤íŠ¸ í”¼ë“œë°±ì´ í˜„ëŒ€ì ì´ê³  ìƒì„¸í•¨.
- **Installation**

  ```bash
  yarn add -D vitest jsdom @testing-library/dom @testing-library/jest-dom @testing-library/react @testing-library/user-event

  // ê¸°ì¡´ Jest í…ŒìŠ¤íŠ¸ ê´€ë ¨ íŒ¨í‚¤ì§€ ì‚­ì œ
  yarn remove jest babel-jest

  ```

- **setting**
  ê¸°ì¡´ì— package.json/jest.setup.js ì„¤ì •ëœ í…ŒìŠ¤íŠ¸ êµ¬ì„±ì„ vitest.config.jsë¡œ ì´ì „

  ```tsx
  // ë³€ê²½ ì „
  //// package.json
  "jest": {
    "collectCoverageFrom": [
      "!<rootDir>/node_modules/"
    ],
    "moduleNameMapper": {
      "lodash-es": "lodash",
    },
    "transformIgnorePatterns": [
      "/node_modules/",
    ],
    "setupFilesAfterEnv": [
      "<rootDir>/jest.setup.js"
    ]
  },

  // ë³€ê²½ í›„
  //// vitest.config.js
  export default defineConfig({
    resolve: {
      alias: {
        "lodash-es": "lodash",
      },
    },
    plugins: [
      react(),
      viteTsconfigPaths(), // tsconfig íŒŒì¼ íŒ¨ìŠ¤ ì—°ë™
    ],
    test: {
      environment: 'jsdom', // React í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ìœ„í•´ ì„¤ì •
      globals: true,        // Jestì™€ ë™ì¼í•œ ê¸€ë¡œë²Œ ë³€ìˆ˜ë¥¼ ì‚¬ìš©
      setupFiles: './src/setupTests.ts', // setup íŒŒì¼
    },
  });

  // src/setupTest.ts
  import '@testing-library/jest-dom';
  ```

  ê¸°ì¡´ ë¦¬ì•¡íŠ¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ì„œ test í™˜ê²½ì„ ê¼­ json ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.
  íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ íƒ€ì…ì— vitest ì¶”ê°€í•´ì£¼ì„¸ìš”.

  ```json
  // tsconfig.json
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "es2020"],
    "target": "ES6",
    "types": ["vite/client", "react", "react-dom", "node", "vitest/globals"], // vitest/globals ì¶”ê°€
    "isolatedModules": true
  },
  ```

  eslint ê¸€ë¡œë²Œ ì²´í¬ íƒ€ì… ë³€ìˆ˜ì— vi ì¶”ê°€

  ```tsx
  // .eslint.js
  module.exports = {
    globals: {
      context: 'readonly',
      vi: true, // vi ì¶”ê°€
    },
  };
  ```

- **jest code migration processing**
  **module mocks**
  ```tsx
  // ë³€ê²½ ì „
  jest.mock('./some-path', () => 'hello');
  // ë³€ê²½ í›„
  vi.mock('./some-path', () => 'hello');
  ```
  **Importing the Original of a Mocked Package**
  ```tsx
  // ë³€ê²½ ì „
  const { cloneDeep } = jest.requireActual('lodash/cloneDeep');
  // ë³€ê²½ í›„
  const { cloneDeep } = await vi.importActual('lodash/cloneDeep');
  ```
  **Replace property**
  [Vitest](https://vitest.dev/guide/migration#replace-property)
  **Done Callback**
  - Vitest v0.10.0 ì´í›„ë¶€í„°ëŠ” callback ìŠ¤íƒ€ì¼ì„ ì§€ì›í•˜ì§€ ì•Šê³  ìˆì–´ì„œ ì§€ì›ì„ í•´ì•¼í•  ê²½ìš° Promise callback í•¨ìˆ˜ë¡œ ë³€ê²½ í•„ìš”
  ```tsx
  it('should work', done => {});
  it('should work', () =>
    new Promise(done => {
      // ...
      done();
    }));
  ```
  **Hooks**
  beforeAll/beforeEach hookì— ëŒ€í•´ì„œ null/undefined ì™¸ì— ê°’ì„ ë°˜í™˜í•´ì•¼í•©ë‹ˆë‹¤.
  ```tsx
  -beforeEach(() => setActivePinia(createTestingPinia())) +
    beforeEach(() => {
      setActivePinia(createTestingPinia());
    });
  ```
  jest hooksëŠ” ë™ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰ë˜ê³ , vitestëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë³‘ë ¬ë¡œ ì§„í–‰í•˜ê²Œ ë©ë‹ˆë‹¤. ë‹¨, hooks ë™ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰ ì‹œ sequence.hooks ì†ì„±ì„ ì§€ì •í•´ì•¼í•©ë‹ˆë‹¤.
  ```tsx
  // vitest.config.js
  export default defineConfig({
    test: {
      sequence: {
        hooks: 'list',
      },
    },
  });
  ```
  **Types**
  vitestëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì†ì„±ì„ ì§€ì›í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì§ì ‘ ìœ í˜•ì„ ê°€ì ¸ì™€ì•¼í•©ë‹ˆë‹¤.
  ```tsx
  // ë³€ê²½ ì „
  let fn: jest.Mock<(name: string) => number>;
  // ë³€ê²½ í›„
  import type { Mock } from 'vitest';
  let fn: Mock<(name: string) => number>;
  ```
  **Timeout**
  ```tsx
  // ë³€ê²½ ì „
  jest.setTimeout(5_000);
  // ë³€ê²½ í›„
  vi.setConfig({ testTimeout: 5_000 });
  ```
- **package.json test commands**
  ```bash
  "test": "vitest",
  "test:run": "vitest run",
  ```

# MSW Migration Guide

- vitest í…ŒìŠ¤íŠ¸ì™€ msw 0.43.1 ë²„ì „ ê°™ì´ ì‚¬ìš© ì‹œ ì•„ë˜ ê°™ì€ ë¬¸êµ¬ì— ì—ëŸ¬ê°€ ë°œìƒ
- vitestì—ì„œ ECMAscript ëª¨ë“ˆì„ ì§€ì›í•˜ê³  ìˆê³  msw ì´ì „ë²„ì „ì—ì„œëŠ” ë¯¸ì§€ì›í•¨ì— ë”°ë¥¸ ì—ëŸ¬ ë°œìƒìœ¼ë¡œ ì¶”ì¸¡(ë²„ì „ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ë³€ê²½í•´ì„œ ìˆ˜ì •)

```tsx
vitest Package subpath './lib' is not defined by "exports" in node_modules/headers-polyfill/package.json
```

- **Installation**
  - msw ë²„ì „ì„ ìµœì‹ ë²„ì „ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ í•¨ì— ë”°ë¥¸ storybookì— ì‚¬ìš©ë˜ëŠ” storybook-addonë„ ë™ì¼í•˜ê²Œ ì—…ê·¸ë ˆì´ë“œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
  - msw-storybook-addon ê´€ë ¨ ìŠ¤í† ë¦¬ë¶€ ì„¤ì •ì„ ê¸°ì¡´ê³¼ ë™ì¼í•©ë‹ˆë‹¤.
  ```tsx
  yarn add -D msw@2.4.11 msw-storybook-addon@2.0.3
  ```
- **msw code migration processing**
  **worker-imports**
  ```tsx
  // ë³€ê²½ ì „
  import { setupWorker } from 'msw';
  // ë³€ê²½ í›„
  import { setupWorker } from 'msw/browser';
  ```
  **Response resolver arguments**
  ```tsx
  // ë³€ê²½ ì „
  rest.get('/resource', (req, res, ctx) => {});
  // ë³€ê²½ í›„
  import { http } from 'msw';
  http.get('/resource', ({ request }) => {
    const url = new URL(request.url);
    const productId = url.searchParams.get('id');
  });
  ```
  **Response declaration**
  ```tsx
  // ë³€ê²½ ì „
  rest.get('/resource', (req, res, ctx) => {
    return res(ctx.status(200), ctx.json({ id: 'abc-123' }));
  });
  // ë³€ê²½ í›„
  import { http } from 'msw';
  http.get('/resource', () => {
    return new Response(JSON.stringify({ id: 'abc-123' }), {
      headers: {
        'Content-Type': 'application/json',
      },
    });
  });
  // ë³€ê²½ í›„ 2
  import { http, HttpResponse } from 'msw';
  export const handlers = [
    http.get('/resource', () => {
      return HttpResponse.json({ id: 'abc-123' }, { status: 200 });
    }),
  ];
  ```
  **Request params**
  ```tsx
  // ë³€ê²½ ì „
  rest.get('/post/:id', req => {
    const { id } = req.params;
  });
  // ë³€ê²½ í›„
  import { http } from 'msw';
  http.get('/post/:id', ({ params }) => {
    const { id } = params;
  });
  ```
  **Request cookies**
  ```tsx
  // ë³€ê²½ ì „
  rest.get('/resource', req => {
    const { token } = req.cookies;
  });
  // ë³€ê²½ í›„
  import { http } from 'msw';
  http.get('/resource', ({ cookies }) => {
    const { token } = cookies;
  });
  ```
  **Request Body**
  ```tsx
  // ë³€ê²½ ì „
  rest.post('/resource', req => {
    // The library would assume a JSON request body
    // based on the request's "Content-Type" header.
    const { id } = req.body;
  });
  // ë³€ê²½ í›„
  import { http } from 'msw';
  http.post('/user', async ({ request }) => {
    // Read the request body as JSON.
    const user = await request.json();
    const { id } = user;
  });
  ```
  [1.x â†’ 2.x](https://mswjs.io/docs/migrations/1.x-to-2.x/#resnetworkerror)

# ê²°ê³¼

ë¹Œë“œ ì„±ëŠ¥: **6.16s â†’ 2.49s ( 3.67s ë¹ ë¦„ )**

![Untitled](./assets/06/Untitled3.png)

![Untitled](./assets/06/Untitled4.png)

Dev Server êµ¬ë™: **167ms â†’ ì—„ì²­ ë¹ ë¦„^^**

![Untitled](./assets/06/Untitled5.png)

# ì°¸ê³ í˜ì´ì§€

- [How to Migrate from create-react-app to Vite? Â· CoreUI](https://coreui.io/blog/how-to-migrate-create-react-app-to-vite/)

- [How to Migrate from create-react-app to Vite using Jest and Browserslist](https://www.freecodecamp.org/news/how-to-migrate-from-create-react-app-to-vite/)

- [[vite] í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìë¥¼ ìœ„í•œ Vite 101](https://nyagm.tistory.com/280)

- [[JS] ë¹„íŠ¸(Vite)ë€? - ë¹„íŠ¸ ì•Œì•„ë³´ê¸°](https://khys.tistory.com/31)

- [Webpack â†’ Vite: ë²ˆë“¤ëŸ¬ ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ì•¼ê¸°](https://engineering.ab180.co/stories/webpack-to-vite)

- [[vite] í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìë¥¼ ìœ„í•œ Vite 101](https://nyagm.tistory.com/280)

- [How to Migrate from create-react-app to Vite using Jest and Browserslist](https://www.freecodecamp.org/news/how-to-migrate-from-create-react-app-to-vite/)

- [CRAì—ì„œ Viteë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ê¸° (feat. ë°°í¬ ì‹œê°„ ì¤„ì´ê¸°)](https://eun-jee.com/post/front-end/CRA_to_Vite/)

- [Docs | Storybook](https://storybook.js.org/docs/builders/vite)
